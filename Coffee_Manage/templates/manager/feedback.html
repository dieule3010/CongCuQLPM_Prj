<!-- Feedback Tab -->
<div id="feedback-tab" class="tab-content {% if active_tab == 'feedback-tab' %}block{% else %}hidden{% endif %}">
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">Customer Feedback</h2>

        <!-- Feedback List -->
        <div id="feedbackList" class="space-y-3">
            {% for f in feedback_list %}
            <div class="feedback-item bg-white border rounded-lg p-4 shadow-sm" id="feedback-{{ f.id }}">
                <div class="flex justify-between items-center">
                    <p class="font-bold text-gray-800">{{ f.customer.name }} ({{ f.customer.email }})</p>
                    <div class="flex gap-2">
                        <button class="toggle-feedback-details px-2 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700"
                            data-feedback-id="{{ f.id }}">
                            View Details
                        </button>
                        <button class="delete-feedback-btn px-2 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700"
                            data-feedback-id="{{ f.id }}">
                            Delete
                        </button>
                    </div>
                </div>

                <div class="feedback-details hidden mt-2">
                    <p class="text-gray-700 mb-1">{{ f.comment }}</p>
                    <p class="text-gray-500 text-sm">Food: {{ f.foodRating }}, Service: {{ f.serviceRating }}</p>
                    <p class="text-gray-500 text-sm">Status: {{ f.status }}</p>
                    <p class="text-gray-500 text-sm">Date: {{ f.date }}</p>

                    <!-- Response -->
                    <textarea class="feedback-reply mt-2 w-full border rounded p-2" placeholder="Type your response...">{{ f.response }}</textarea>
                    <button class="send-feedback-reply mt-2 px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700"
                        data-feedback-id="{{ f.id }}">
                        Send Response
                    </button>
                </div>
            </div>
            {% empty %}
            <p class="text-gray-500">No feedback yet.</p>
            {% endfor %}
        </div>
    </div>
</div>
<script>
 const csrftoken = '{{ csrf_token }}';

// Reply feedback
document.querySelectorAll('.feedback-reply-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        const response = document.querySelector(`#feedback-${id} .feedback-response`).value.trim();
        if(!response) return alert("Response cannot be empty");

        fetch("{% url 'feedback_reply' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": csrftoken,
                "Content-Type": "application/x-www-form-urlencoded",
            },
            body: `feedback_id=${id}&response=${encodeURIComponent(response)}`
        })
        .then(res => res.json())
        .then(data => {
            if(data.success){
                alert("Reply sent!");
            } else {
                alert("Error: " + (data.error || "Unknown"));
            }
        });
    });
});

// Delete feedback
document.querySelectorAll('.feedback-delete-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        if(!confirm("Are you sure?")) return;

        fetch("{% url 'feedback_delete' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": csrftoken,
                "Content-Type": "application/x-www-form-urlencoded",
            },
            body: `feedback_id=${id}`
        })
        .then(res => res.json())
        .then(data => {
            if(data.success){
                document.getElementById(`feedback-${id}`).remove();
            } else {
                alert("Error: " + (data.error || "Unknown"));
            }
        });
    });
});


</script>
